function addControlPanel(){map.addControl(new PanelControl);$.ajax({url:"app/control_panel",success:function(e){$("#control_panel").html(e);addDataHandlerListeners();addCollapseListeners();setDefaultData()}})}function addDataHandlerListeners(){addUpdateButtonListeners();addCheckBoxListeners();addTabsListener();addDropdownListeners();addAllCimesListener();addEnterListener()}function addUpdateButtonListeners(){helperAddDataHandlerListeners("update_map_btn")}function addCheckBoxListeners(){helperAddDataHandlerListeners("main_api_category")}function helperAddDataHandlerListeners(e){$("."+e).each(function(e){var t=$(this).attr("api");var n=DataHandlerMapper[t];if(!n||!n.handle){console.log(t+" - cannot find handler");return}$(this).click(function(e){checkBoxHandler(e,t,n.handle)})})}function checkBoxHandler(e,t,n){enable_preloader();var r=getLayers();if(!(t in r)){console.log("no layer with this name");disable_preloader();return}if($("#"+t+"_checkbox").is(":checked")){n()}else{removeDataFromAllLayers(t);removeAllLabels(t);disable_preloader()}}function addTabsListener(){$('a[data-toggle="tab"]').on("shown.bs.tab",function(e){var t=$(e.target).attr("action");if(t==="draw"){var n=$(e.target).attr("api");var r=$("#draw_api_tab_"+n).attr("allowed_shapes");if(r){r=r.split(" ");enableDrawing(r)}else{console.log("no allowedShapes defined")}}else{disableDrawing()}})}function addCollapseListeners(){$(".api_accordion").each(function(e){$(this).click(function(e){var t=$(this).attr("aria-controls");collapseListener(e,t)})})}function addDropdownListeners(){$(".dropdown li").click(function(e){var t="#"+$(this).attr("parent_text_id");$(t).attr("v",$(this).attr("v"));$(t).html($(this).text())})}function collapseListener(e,t){e.preventDefault();var n="#"+t;if($(n).hasClass("in")){$("#span_arrow_"+t).removeClass("glyphicon-chevron-down");$("#span_arrow_"+t).addClass("glyphicon-chevron-right")}else{$("#span_arrow_"+t).removeClass("glyphicon-chevron-right");$("#span_arrow_"+t).addClass("glyphicon-chevron-down")}return true}function addAllCimesListener(){$(".police_collapsable_1").each(function(){if($(this).attr("id")!=="all-crime"){$(this).attr("disabled","disabled")}});$("#all-crime").click(function(){if($(this).is(":checked")){$(".police_collapsable_1").each(function(){if($(this).attr("id")!=="all-crime"){$(this).prop("checked",false);$(this).attr("disabled","disabled")}})}else{$(".police_collapsable_1").each(function(){if($(this).attr("id")!=="all-crime")$(this).removeAttr("disabled")})}})}function addEnterListener(){$(".press-enter").each(function(){var e=$(this);$(this).keyup(function(t){if(t.keyCode===13){$("#"+e.attr("api")+"_update_map").click()}})})}function setDefaultData(){enable_preloader();setDefaultCheckboxes();PoliceHandler.handle()}function setDefaultCheckboxes(){$("#police_checkbox").prop("checked",true)}function isTabActive(e){e="#"+e;if($(e).length===0){console.log("tab doesnt exist");return false}return $(e).hasClass("active")}function isSearchCityTabActive(e){var t="search_api_tab_heading_"+e;return isTabActive(t)}function isDrawAreaTabActive(e){var t="draw_api_tab_heading_"+e;return isTabActive(t)}function isMixedSearchActive(e){var t="mixed_api_tab_heading_"+e;return isTabActive(t)}function isAllUkTabActive(e){var t="entire_uk_api_tab_"+e;return isTabActive(t)}function getSearchCityText(e){var t="#search_city_"+e;if($(t).length===0){return""}return $(t).val()}function getDropdownValue(e,t){var n="#dropdown_value_container_"+e+"_"+t;if($(n).length===0){return undefined}return $(n).attr("v")}function addLabel(e,t){var n="#city_name_container_"+e;var r=getNameForLabelFromRequest(e);var i=["label-red","label-blue","label-orange","label-grey","label-green"];var s=i[Math.floor(Math.random()*i.length)];var o="#span_container_"+e+"_"+t;if($(o).length!==0)return;$(n).append('<span id="span_container_'+e+"_"+t+'" class="badge badge-default '+s+'">'+r+" |"+'<a class="label_delete" a_parent="span_container_'+e+"_"+t+'" '+'href="#" id="'+e+"_"+t+'" md5="'+t+'"  api="'+e+'"> '+"<strong>âœ–</strong> "+"</a> "+"</span>");$("#"+e+"_"+t).click(function(){var e=$(this).attr("api");var t=$(this).attr("md5");var n="#"+$(this).attr("a_parent");deleteLabelListener(e,t,n)})}function removeLabel(e){if(e&&e.remove){e.remove()}else{console.log("id is not $")}}function removeAllLabels(e){var t="#city_name_container_"+e;$(t).empty()}function deleteLabelListener(e,t,n){removeDataFromLayer(e,"markers",t);removeDataFromLayer(e,"heatmap",t);removeLabel($(n));if(isDrawAreaTabActive(e)){deleteDrawnArea()}}function getNameForLabelFromRequest(e){if(isSearchCityTabActive(e)){return getSearchCityText(e)}else if(isDrawAreaTabActive(e)){return"Drawn"}else if(isMixedSearchActive(e)){return getMixedSearchText(e)}else{console.log("unrecognised tab");return":))"}}function getDrawCoordinates(){var e=getDrawnAreaBounds();return e}function getMixedSearchText(e){var t="#mixed_city_"+e;if($(t).length===0){console.log("cannot find mixed search");return""}return $(t).val()}function getRenderMode(e){var t=[];$(".render_mode_"+e).each(function(e){if($(this).is(":checked")){t.push($(this).attr("mode"))}});return t}function setMainApiCategoryCheckbox(e,t){var n="#"+e+"_checkbox";$(n).prop(checked,t)}function getApiDate(e){var t="#date_selector_"+e;if($(t).length===0)return undefined;return $(t).val()}function showError(e){$("#error_content").text(e);$("#alert_container").show();$("#alert_close_button").click(function(){$("#alert_container").hide()})}function enableDrawing(e){if(drawControl){disableDrawing()}var t={polygon:0,polyline:0,rectangle:0,circle:0,marker:0};e.forEach(function(e){if(t[e]===0){t[e]=true}});featureGroup=L.featureGroup().addTo(map);drawControl=(new L.Control.Draw({edit:{featureGroup:featureGroup},draw:t})).addTo(map);map.on("draw:created",showPolygonArea);map.on("draw:edited",showPolygonAreaEdited)}function disableDrawing(){if(drawControl!==undefined){drawControl.removeFrom(map);featureGroup.clearLayers();area=undefined}drawControl=undefined}function deleteDrawnArea(){featureGroup.clearLayers()}function getDrawnAreaBounds(){return area}function getRawLayer(){return rawLayer}function showPolygonAreaEdited(e){e.layers.eachLayer(function(e){showPolygonArea({layer:e})})}function showPolygonArea(e){featureGroup.clearLayers();featureGroup.addLayer(e.layer);area=e.layer.toGeoJSON();rawLayer=e.layer;console.log(e.layer.getLatLngs());console.log(area);e.layer.bindPopup((LGeo.area(e.layer)/1e6).toFixed(2)+" km<sup>2</sup>");e.layer.openPopup()}function init(){if(!map){setMap(map_init_options)}initModel();initView();addControlPanel()}function zoomTo(e,t){if(map){map.setZoom(200);map.panTo(e);map.setZoom(t);map.setView(e)}}function setMap(e){L.mapbox.accessToken=e.mapbox_access_token;map=L.mapbox.map("map",null,{zoomControl:false}).setView(e.centerLocation,e.zoomLevel);var t="tile.openstreetmap.org";var n="tiles.mapbox.com/v3/{id}";var r=L.tileLayer("http://{s}."+t+"/{z}/{x}/{y}.png",{maxZoom:18,id:"examples.map-20v6611k"}).addTo(map);L.control.zoom({position:"bottomleft"}).addTo(map);return map}function getServerData(){var e=$("#map").data("fromserver");return e}function getAPINames(){var e=getServerData();return e.categoriesAPI}function attachButtonListeners(){$("#toggle_nav").on("click",function(){$("#main_nav").toggle({duration:600})});$("#go").on("click",function(){enable_preloader();var e=DataHandlerMapper["geoCoding"];e.handle();disable_preloader()});$("#location").keypress(function(e){if(e.which==13){$("#go").click()}});$("#reset").on("click",function(){zoomTo(DEFAULT_centerLocation,DEFAULT_ZOOM)})}function enable_preloader(){$("#stop_ajax").show();$.blockUI({message:$("#preloader"),css:{border:"none",padding:"15px",backgroundColor:"#000","-webkit-border-radius":"10px","-moz-border-radius":"10px",opacity:.5,color:"#fff"}})}function disable_preloader(){$("#stop_ajax").hide();setTimeout($.unblockUI,80)}function ageOfTimestamp(e){var t=Date.now();return t-e}function getAPIFromRequestObject(e){if(e&&e.name){return e.name}return undefined}function getResponseApi(e){if(e&&e.data&&e.data.api){return e.data.api}return undefined}function getResponseData(e){console.log(e);if(e&&e.data){return e.data}return undefined}function circleLayerToCircle(e){var t={};t["type"]="area";t["radius"]=e.getRadius();t["lat"]=e.getgetLatLng().lat;t["long"]=e.getgetLatLng().lng;return t}function rectangleLayerToRectangle(e){var t={};t["type"]="rectangle";var n=e.getBounds().getNorthWest();t["northEast"]=[n.lat,n.lng];var r=e.getBounds().getSouthWest();t["southWest"]=[r.lat,r.lng];return t}function polygonLayerToPolygon(e){var t={};t.type="polygon";var n=e.getLatLngs();var r=[];n.forEach(function(e){var t=[];t.push(e.lat);t.push(e.lng);r.push(t)});t.points=r;return t}function getHousesPrettyHtml(e){var t=e.bathNumber?e.bathNumber:"N/A";var n=e.bedroomNumber?e.bedroomNumber:"N/A";var r=e.currency?e.currency:"N/A";var i=e.img_height?e.img_height:"N/A";var s=e.img_url?e.img_url:"N/A";var o=e.img_width?e.img_width:"N/A";var u=e.price?e.price:"N/A";var a=e.price_type?e.price_type:"N/A";var f=e.property_type?e.property_type:"N/A";var l=e.summary?e.summary:"N/A";var c=e.title?e.title:"N/A";var h=getDropdownValue("house","listing_type");var p=l+"<p><img width="+o+"px height="+i+" src="+s+"></p>";var d="<tr><td>Bedrooms</td><td>"+n+"</td></tr>"+"<tr><td>Bathrooms</td><td>"+t+"</td></tr>"+"<tr><td>Rent/buy</td><td>"+h+"</td></tr>"+"<tr><td>Price</td><td>"+u+"("+a+")</td></tr>"+"<tr><td>Property type</td><td>"+f+"</td></tr>";var v='<div class="panel panel-info">'+"<!-- Default panel contents -->"+'<div class="panel-heading">'+c+"</div>"+'<div class="panel-body">'+"  <p>"+p+"</p>"+"</div>"+"<!-- Table -->"+'<table class="table">'+d+"</table>"+"</div>";return v}function getRestaurantPrettyHtml(e){var t=e.name?e.name:"N/A";var n=e.hygine?e.hygine:"N/A";var r=e.mang?e.man:"N/A";var i=e.structural?e.structural:"N/A";var s="Rating for the following categories";var o="<tr><td>Hygine</td><td>"+n+"</td></tr>"+"<tr><td>Management</td><td>"+r+"</td></tr>"+"<tr><td>Structural</td><td>"+i+"</td></tr>";var u='<div class="panel panel-info">'+"<!-- Default panel contents -->"+'<div class="panel-heading">'+t+" </div>"+'<div class="panel-body">'+"  <p>"+s+"</p>"+"</div>"+"<!-- Table -->"+'<table class="table">'+o+"</table>"+"</div>";return u}function getAirqualityPrettyHtml(e){var t=e.title;var n=e.pollutionLevel;var r="Air quality";var i="<tr><td>Station</td><td>"+t+"</td></tr>"+"<tr><td>Pollution Level</td><td>"+n+"</td></tr>";var s='<div class="panel panel-info">'+"<!-- Default panel contents -->"+'<div class="panel-heading">'+t+" </div>"+'<div class="panel-body">'+"  <p>"+r+"</p>"+"</div>"+"<!-- Table -->"+'<table class="table">'+i+"</table>"+"</div>";return s}function getPolicePrettyHtml(e){var t=e.category;var n=e.outcome_status?e.outcome_status.category:"N/A";var r=e.outcome_status?e.outcome_status.date:"N/A";var i="Crime details";var s="<tr><td>Category</td><td>"+t+"</td></tr>"+"<tr><td>Outcome</td><td>"+n+"</td></tr>"+"<tr><td>Date</td><td>"+r+"</td></tr>";var o='<div class="panel panel-info">'+"<!-- Default panel contents -->"+'<div class="panel-heading">'+"Crime"+" </div>"+'<div class="panel-body">'+"  <p>"+i+"</p>"+"</div>"+"<!-- Table -->"+'<table class="table">'+s+"</table>"+"</div>";return o}function getSchoolsPrettyHtml(e){var t=e.capacity?e.capacity:"N/A";var n=e.gender?e.gender:"N/A";var r=e.name?e.name:"N/A";var i=e.phase_of_education;var s="";if(i){s=e.phase_of_education.label?e.phase_of_education.label:"N/A"}else{s="N/A"}var o=e.type_of_establishment?e.type_of_establishment:"N/A";var u=e.religious_character?e.religious_character:"N/A";var a=e.outcome_status?e.outcome_status.category:"N/A";var f="School details";var l="<tr><td>Capacity</td><td>"+t+"</td></tr>"+"<tr><td>Gender</td><td>"+n+"</td></tr>"+"<tr><td>Establishment</td><td>"+o+"</td></tr>"+"<tr><td>Religious character</td><td>"+u+"</td></tr>"+"<tr><td>Phase of education</td><td>"+s+"</td></tr>";var c='<div class="panel panel-info">'+"<!-- Default panel contents -->"+'<div class="panel-heading">'+r+" </div>"+'<div class="panel-body">'+"  <p>"+f+"</p>"+"</div>"+"<!-- Table -->"+'<table class="table">'+l+"</table>"+"</div>";return c}function initModel(){Model=initialiseModel(getAPINames())}function abortAjaxRequest(){if(ajax_request){ajax_request.abort()}}function makeRequest(e,t,n,r){ajax_request=$.ajax({type:"POST",url:domain+"/app/allData",dataType:"json",contentType:"application/json",data:JSON.stringify(e),error:function(e){var t="Status: "+e.status+" "+e.statusText+", Response: "+e.responseText;console.log("Status: "+e.status+" "+e.statusText+", Response: "+e.responseText);if(error_msg[e.status]){n(error_msg[e.status])}else{n(t)}return},success:function(i){console.log("Server returned, receiving the data");console.log(i);if(t&&r){t(e,i,r,n)}else{console.log("No callback was specified to handle the response!")}}})}function initLayers(e){var t={};e.forEach(function(e){t[e]={};t[e].heatmap={};t[e].markers={}});return t}function createMarkersEmptyLayer(){return(new L.MarkerClusterGroup).addTo(map)}function createHeatmapEmptyLayer(){return L.heatLayer([],{maxZoom:12}).addTo(map)}function getLayers(){return layers}function getLayer(e,t,n){if(layers&&layers[e]&&layers[e][t]&&layers[e][t][n]){return layers[e][t][n]}else{return undefined}}function addLayer(e,t,n){if(t==="markers"){layers[e][t][n]=createMarkersEmptyLayer();return layers[e][t][n]}else if(t==="heatmap"){layers[e][t][n]=createHeatmapEmptyLayer();return layers[e][t][n]}}function removeDataFromAllLayers(e){var t=Object.keys(layers[e]["heatmap"]);t.forEach(function(t){var n=layers[e]["heatmap"][t];if(n&&map.hasLayer(n)){map.removeLayer(n);layers[e]["heatmap"][t]=createHeatmapEmptyLayer()}});var n=Object.keys(layers[e]["markers"]);n.forEach(function(t){var n=layers[e]["markers"][t];if(n&&map.hasLayer(n)){map.removeLayer(n);layers[e]["markers"][t]=createMarkersEmptyLayer()}})}function removeDataFromLayer(e,t,n){if(!(e in layers)){console.log("Trying to remove data from layer which is not in the layers collection ");return false}if(!(t in layers[e])){console.log("Trying to remove data from non existing layer type");return false}if(t==="markers"){var r=getLayer(e,"markers",n);if(r){layers[e]["markers"][n]=createMarkersEmptyLayer();map.removeLayer(r);return true}else{return false}}else if(t==="heatmap"){var i=getLayer(e,"heatmap",n);if(i){i.setLatLngs([]);return true}else{return false}}else{console.log("Non-supported layer type");return false}}jQuery(function(){jQuery("#location").autocomplete({source:function(e,t){jQuery.getJSON("http://gd.geobytes.com/AutoCompleteCity?callback=?&filter=UK&q="+e.term,function(e){t(e)})},minLength:2,select:function(e,t){var n=t.item;jQuery("#location").val(n.value);return false},open:function(){jQuery(this).removeClass("ui-corner-all").addClass("ui-corner-top")},close:function(){jQuery(this).removeClass("ui-corner-top").addClass("ui-corner-all")}});jQuery("#location").autocomplete("option","delay",10)});var PanelControl=L.Control.extend({options:{position:"topright"},onAdd:function(e){var t=L.DomUtil.create("div","navigation-control");t.setAttribute("id","control_container");L.DomEvent.disableClickPropagation(t);var n=L.DomUtil.create("div","navv",t);n.setAttribute("id","control_panel");return t}});var DataHandler=function(){var e=function(e,t,n){console.log("controller sending request to the model, request data:");console.log(e);Model.query(e,t,n)};var t=function(e){console.log("Default error handler: Error message: "+e);showError(e);disable_preloader()};var n=function(e){console.log("handle_respnse data:");console.log(e);var t=getResponseApi(e);View.handle(e,t);disable_preloader();console.log("All visualised")};var r=function(e){var t={};if(isSearchCityTabActive(e)){t.type="place";t.name=getSearchCityText(e);if(!t.name){console.log(e+" empty city name");return undefined}}else if(isDrawAreaTabActive(e)){var n=getDrawCoordinates();if(n===undefined){console.log(e+" empty draw coordinates");return undefined}t.type=n.geometry.type.toLowerCase();switch(t.type){case"polygon":var r=polygonLayerToPolygon(getRawLayer());return r;case"circle":var i=circleLayerToCircle(getRawLayer());return i;case"rectangle":var s=rectangleLayerToRectangle(getRawLayer());return s;default:console.log("Cannot determine type of Draw ");return undefined}}else if(isMixedSearchActive(e)){t.type="place";t.name=getMixedSearchText(e);if(!t.name){console.log(e+" empty mixed search field");return undefined}}else if(isAllUkTabActive(e)){t.all=true}else{return undefined}return t};var i={makeRequest:e,defaultErrorCallback:t,handle_response:n,getLocation:r};return i}();var PoliceHandler=function(e){var t="police";var n=function(){var t=i();e.makeRequest(t,r,e.defaultErrorCallback)};var r=function(t){e.handle_response(t)};var i=function(){var n={};n.name=t;var r={};r.category=s();if(r.category.length===0){alert("Please select Police Crime category");return undefined}var i=getApiDate(t);if(!i){alert("Please select Police date");return undefined}r.date=i;r.location=e.getLocation(t);if(r.location===undefined)return undefined;n.args=r;return n};var s=function(){var e=[];$(".police_collapsable_1").each(function(t){if($(this).is(":checked")){e[t]=$(this).attr("id")}});return e};var o={handle:n};return o}(DataHandler);var RestaurantHandler=function(e){var t="restaurant";var n=function(){var t=i();e.makeRequest(t,r,e.defaultErrorCallback)};var r=function(t){e.handle_response(t)};var i=function(){var n={};n.name=t;var r={};r.location=e.getLocation(t);if(r.location===undefined)return undefined;n.args=r;return n};var s={handle:n};return s}(DataHandler);var AirqualityHandler=function(e){var t="airquality";var n=function(){var t=i();e.makeRequest(t,r,e.defaultErrorCallback)};var r=function(t){e.handle_response(t)};var i=function(){var e={};e.name=t;return e};var s={handle:n};return s}(DataHandler);var HousesHandler=function(e){var t="house";var n=function(){var t=i();e.makeRequest(t,r,e.defaultErrorCallback)};var r=function(t){e.handle_response(t)};var i=function(){var n={};var r={};n.name=t;r.location=e.getLocation(t);if(!r.location){return undefined}r.listing_type=getDropdownValue(t,"listing_type");n.args=r;return n};var s={handle:n};return s}(DataHandler);var SchoolsHandler=function(e){var t="schools";var n=function(){var t=i();e.makeRequest(t,r,e.defaultErrorCallback)};var r=function(t){e.handle_response(t)};var i=function(){var n={};var r={};n.name=t;r.location=e.getLocation(t);if(!r.location){return undefined}n.args=r;return n};var s={handle:n};return s}(DataHandler);var GeoCodingHandler=function(e){var t="geocoding";var n=function(){console.log("~~~ handling geocoding");var t=i();if(t===undefined){console.log("cannot construct request data object");return}e.makeRequest(t,r,e.defaultErrorCallback)};var r=function(e){console.log("====== > handle_geoCoding_response:");console.log(e);if(map){zoomTo(s(e.data),DEFAULT_ZOOM+5)}else{init()}};var i=function(){var e={};var t={};e.name="geocoding";var n=$("#location").val();if(n==="")return undefined;t.location={type:"place",name:n};e.args=t;return e};var s=function(e){console.log("~~~");console.log(e);console.log("~~~");var t=L.latLng(e["data"]["results"][0]["geometry"]["location"]["lat"],e["data"]["results"][0]["geometry"]["location"]["lng"]);return t};var o=function(e){bounds=undefined;if(L.latLng(e["data"]["results"][0]["geometry"]["bounds"])){var t=L.latLng(e["data"]["results"][0]["geometry"]["bounds"]["northeast"]["lat"],e["data"]["results"][0]["geometry"]["bounds"]["northeast"]["lng"]);var n=L.latLng(e["data"]["results"][0]["geometry"]["bounds"]["southwest"]["lat"],e["data"]["results"][0]["geometry"]["bounds"]["southwest"]["lng"]);bounds=L.latLngBounds(n,t)}return bounds};var u=function(){var e=$("#location").val();return e};var a={handle:n};return a}(DataHandler);var DataHandlerMapper={police:PoliceHandler,restaurant:RestaurantHandler,geoCoding:GeoCodingHandler,airquality:AirqualityHandler,schools:SchoolsHandler,house:HousesHandler};var drawControl;var featureGroup;var area;var rawLayer;var DEFAULT_LOCATION_NAME="United Kingdom";var DEFAULT_centerLocation=L.latLng(55.378051,-3.435973);var DEFAULT_northEast=L.latLng(60.8606697,33.916555);var DEFAULT_southWest=L.latLng(34.5625145,-8.649357199999999);var DEFAULT_ZOOM=6;var map_init_options={centerLocation:DEFAULT_centerLocation,zoomLevel:DEFAULT_ZOOM,mapbox_access_token:"pk.eyJ1IjoiY2hpcHNhbiIsImEiOiJqa0JwV1pnIn0.mvduWzyRdcHxK_QIOpetFg"};var map;var domain=document.location.origin;$(document).ready(function(){init();attachButtonListeners()});var Utils={renderFieldErrorTooltip:function(e,t,n){var r;if(typeof n==="undefined"){n="right"}r=$(e);r.tooltip({title:t,trigger:"manual",placement:n});r.tooltip("show");r.addClass("error");r.on("focus click",function(e){r.removeClass("error");r.tooltip("hide")})}};(function(){$("#cancel_request").click(function(){abortAjaxRequest();disable_preloader()});$("#background_request").click(function(){disable_preloader()})})();var MD5=function(e){function t(e,t){return e<<t|e>>>32-t}function n(e,t){var n,r,i,s,o;i=e&2147483648;s=t&2147483648;n=e&1073741824;r=t&1073741824;o=(e&1073741823)+(t&1073741823);if(n&r){return o^2147483648^i^s}if(n|r){if(o&1073741824){return o^3221225472^i^s}else{return o^1073741824^i^s}}else{return o^i^s}}function r(e,t,n){return e&t|~e&n}function i(e,t,n){return e&n|t&~n}function s(e,t,n){return e^t^n}function o(e,t,n){return t^(e|~n)}function u(e,i,s,o,u,a,f){e=n(e,n(n(r(i,s,o),u),f));return n(t(e,a),i)}function a(e,r,s,o,u,a,f){e=n(e,n(n(i(r,s,o),u),f));return n(t(e,a),r)}function f(e,r,i,o,u,a,f){e=n(e,n(n(s(r,i,o),u),f));return n(t(e,a),r)}function l(e,r,i,s,u,a,f){e=n(e,n(n(o(r,i,s),u),f));return n(t(e,a),r)}function c(e){var t;var n=e.length;var r=n+8;var i=(r-r%64)/64;var s=(i+1)*16;var o=Array(s-1);var u=0;var a=0;while(a<n){t=(a-a%4)/4;u=a%4*8;o[t]=o[t]|e.charCodeAt(a)<<u;a++}t=(a-a%4)/4;u=a%4*8;o[t]=o[t]|128<<u;o[s-2]=n<<3;o[s-1]=n>>>29;return o}function h(e){var t="",n="",r,i;for(i=0;i<=3;i++){r=e>>>i*8&255;n="0"+r.toString(16);t=t+n.substr(n.length-2,2)}return t}function p(e){e=e.replace(/\r\n/g,"\n");var t="";for(var n=0;n<e.length;n++){var r=e.charCodeAt(n);if(r<128){t+=String.fromCharCode(r)}else if(r>127&&r<2048){t+=String.fromCharCode(r>>6|192);t+=String.fromCharCode(r&63|128)}else{t+=String.fromCharCode(r>>12|224);t+=String.fromCharCode(r>>6&63|128);t+=String.fromCharCode(r&63|128)}}return t}var d=Array();var v,m,g,y,b,w,E,S,x;var T=7,N=12,C=17,k=22;var L=5,A=9,O=14,M=20;var _=4,D=11,P=16,H=23;var B=6,j=10,F=15,I=21;e=p(e);d=c(e);w=1732584193;E=4023233417;S=2562383102;x=271733878;for(v=0;v<d.length;v+=16){m=w;g=E;y=S;b=x;w=u(w,E,S,x,d[v+0],T,3614090360);x=u(x,w,E,S,d[v+1],N,3905402710);S=u(S,x,w,E,d[v+2],C,606105819);E=u(E,S,x,w,d[v+3],k,3250441966);w=u(w,E,S,x,d[v+4],T,4118548399);x=u(x,w,E,S,d[v+5],N,1200080426);S=u(S,x,w,E,d[v+6],C,2821735955);E=u(E,S,x,w,d[v+7],k,4249261313);w=u(w,E,S,x,d[v+8],T,1770035416);x=u(x,w,E,S,d[v+9],N,2336552879);S=u(S,x,w,E,d[v+10],C,4294925233);E=u(E,S,x,w,d[v+11],k,2304563134);w=u(w,E,S,x,d[v+12],T,1804603682);x=u(x,w,E,S,d[v+13],N,4254626195);S=u(S,x,w,E,d[v+14],C,2792965006);E=u(E,S,x,w,d[v+15],k,1236535329);w=a(w,E,S,x,d[v+1],L,4129170786);x=a(x,w,E,S,d[v+6],A,3225465664);S=a(S,x,w,E,d[v+11],O,643717713);E=a(E,S,x,w,d[v+0],M,3921069994);w=a(w,E,S,x,d[v+5],L,3593408605);x=a(x,w,E,S,d[v+10],A,38016083);S=a(S,x,w,E,d[v+15],O,3634488961);E=a(E,S,x,w,d[v+4],M,3889429448);w=a(w,E,S,x,d[v+9],L,568446438);x=a(x,w,E,S,d[v+14],A,3275163606);S=a(S,x,w,E,d[v+3],O,4107603335);E=a(E,S,x,w,d[v+8],M,1163531501);w=a(w,E,S,x,d[v+13],L,2850285829);x=a(x,w,E,S,d[v+2],A,4243563512);S=a(S,x,w,E,d[v+7],O,1735328473);E=a(E,S,x,w,d[v+12],M,2368359562);w=f(w,E,S,x,d[v+5],_,4294588738);x=f(x,w,E,S,d[v+8],D,2272392833);S=f(S,x,w,E,d[v+11],P,1839030562);E=f(E,S,x,w,d[v+14],H,4259657740);w=f(w,E,S,x,d[v+1],_,2763975236);x=f(x,w,E,S,d[v+4],D,1272893353);S=f(S,x,w,E,d[v+7],P,4139469664);E=f(E,S,x,w,d[v+10],H,3200236656);w=f(w,E,S,x,d[v+13],_,681279174);x=f(x,w,E,S,d[v+0],D,3936430074);S=f(S,x,w,E,d[v+3],P,3572445317);E=f(E,S,x,w,d[v+6],H,76029189);w=f(w,E,S,x,d[v+9],_,3654602809);x=f(x,w,E,S,d[v+12],D,3873151461);S=f(S,x,w,E,d[v+15],P,530742520);E=f(E,S,x,w,d[v+2],H,3299628645);w=l(w,E,S,x,d[v+0],B,4096336452);x=l(x,w,E,S,d[v+7],j,1126891415);S=l(S,x,w,E,d[v+14],F,2878612391);E=l(E,S,x,w,d[v+5],I,4237533241);w=l(w,E,S,x,d[v+12],B,1700485571);x=l(x,w,E,S,d[v+3],j,2399980690);S=l(S,x,w,E,d[v+10],F,4293915773);E=l(E,S,x,w,d[v+1],I,2240044497);w=l(w,E,S,x,d[v+8],B,1873313359);x=l(x,w,E,S,d[v+15],j,4264355552);S=l(S,x,w,E,d[v+6],F,2734768916);E=l(E,S,x,w,d[v+13],I,1309151649);w=l(w,E,S,x,d[v+4],B,4149444226);x=l(x,w,E,S,d[v+11],j,3174756917);S=l(S,x,w,E,d[v+2],F,718787259);E=l(E,S,x,w,d[v+9],I,3951481745);w=n(w,m);E=n(E,g);S=n(S,y);x=n(x,b)}var q=h(w)+h(E)+h(S)+h(x);return q.toLowerCase()};var error_msg={empty_request:"The data passed to the query was empty",bad_response:"The data received cannot be interpreted",empty_response:"Our hardworking servers returned no results for your query",400:"The request object was not constucted properly"};var Model;var initialiseModel=function(e){if(Model)return Model;var t=function(e,t,i){if(!e){i(error_msg.empty_request);return}var s=r.getEntry(e);if(s===undefined){makeRequest(e,n,i,t)}else{n(e,s,t,i)}};var n=function(e,t,n,i){var s=r.addEntry(e,t);var o=function(e){var t={};if(!e&&!e.data){return undefined}var n=function(){if(e.data.features.length===0){i(error_msg.empty_response);return undefined}return L.geoJson(e.data)};var r=function(){var t=L.geoJson(e.data);var n=[];t.eachLayer(function(e){var t=L.marker(e.getLatLng());t.bindPopup(JSON.stringify(e.feature.properties));n.push(t)});if(n.length===0){i(error_msg.empty_response);return undefined}return n};t.data=e;t.md5_of_request=s;t.getHeatmapData=n;t.getMarkersData=r;return t}(t);if(o){n(o)}else{if(i){i(error_msg.bad_response)}else{console.log("error occured when parsing the response. no error function to handle the error.")}}};var r=function(e){var t={};var n=3e5;e.forEach(function(e){t[e]={}});t.geoCoding={};var r=function(e){var t=s(e);if(t===undefined)return undefined;return t};var i=function(e,n){var r=getAPIFromRequestObject(e);if(!(r in t)){console.log("trying to add non valid API to cache");return undefined}var i=MD5(JSON.stringify(e));if(t[r][i]){return i}else{var s=Date.now();var o={};o.data=n;o.timestamp=s;t[r][i]=o;console.log("Added a new entry in "+r+"'s cache");return i}};var s=function(e){var r=getAPIFromRequestObject(e);if(!r)return undefined;if(!(r in t)){console.log("trying to check cache for non valid API");return undefined}var i=MD5(JSON.stringify(e));var s=t[r][i];if(!s){console.log("API cache doesn't have the entry for the request");return undefined}var o=s.timestamp;if(ageOfTimestamp(o)<n){console.log("Cache object is fresh enough");return s.data}else{console.log("Cache object is not fresh enough");delete t[r][i];return undefined}};return{getEntry:r,addEntry:i}}(e);return{query:t}};var ajax_request;var View;var layers;var initView=function(){layers=initLayers(getAPINames());View=initialiseView()};var initialiseView=function(){if(View)return View;var e=function(e,n){if(!n){console.log("Unexpected - View cannot check for which API the data is");return}if(n in l){l[n].handle(e,n)}else{t(e,n)}};var t=function(e,t){var i=getRenderMode(t);var s=removeDataFromLayer(t,"markers",e.md5_of_request);var o=removeDataFromLayer(t,"heatmap",e.md5_of_request);addLabel(t,e.md5_of_request);i.forEach(function(i){if(i==="markers"){r(e,t)}else if(i==="heatmap"){n(e,t)}else{console.log("Render mode not specified");return}})};var n=function(e,t){console.log("adding data to "+t+"'s heatmap layer");var n=e.getHeatmapData;var r=n();var i=e.md5_of_request;var s=getLayer(t,"heatmap",i);if(!s){s=addLayer(t,"heatmap",i)}r.eachLayer(function(e){s.addLatLng(e.getLatLng())});map.fitBounds(r.getBounds())};var r=function(e,t){console.log("adding data to "+t+"'s markers layer");var n=e.md5_of_request;var r=layers[t]["markers"][n];if(!r){r=addLayer(t,"markers",n)}var i=e.getMarkersData;var s=i();if(s){r.addLayers(s);map.fitBounds(r.getBounds())}};var i=function(){var e=function(e,n){t(e,n);var r=getLayer(n,"markers",e.md5_of_request);if(r){r.eachLayer(function(e){var t=e.getPopup().getContent();t=JSON.parse(t);var n=getPolicePrettyHtml(t);e.setPopupContent(n)})}else{console.log("no layer :(")}};var n={handle:e};return n}();var s=function(){var e=function(e,n){t(e,n);var r=getLayer(n,"markers",e.md5_of_request);if(r){r.eachLayer(function(e){var t=e.getPopup().getContent();t=JSON.parse(t);var n=getAirqualityPrettyHtml(t);e.setPopupContent(n)})}else{console.log("no layer :(")}};var n={handle:e};return n}();var o=function(){var e=function(e,n){t(e,n);var r=getLayer(n,"markers",e.md5_of_request);if(r){r.eachLayer(function(e){var t=e.getPopup().getContent();t=JSON.parse(t);var n=getRestaurantPrettyHtml(t);e.setPopupContent(n)})}else{console.log("no layer :(")}};var n={handle:e};return n}();var u=function(){var e=function(e,n){t(e,n);var r=getLayer(n,"markers",e.md5_of_request);if(r){r.eachLayer(function(e){var t=e.getPopup().getContent();t=JSON.parse(t);var n=getHousesPrettyHtml(t);e.setPopupContent(n)})}else{console.log("no layer :(")}};var n={handle:e};return n}();var a=function(){var e=function(e,n){t(e,n);var r=getLayer(n,"markers",e.md5_of_request);if(r){r.eachLayer(function(e){var t=e.getPopup().getContent();t=JSON.parse(t);var n=getSchoolsPrettyHtml(t);e.setPopupContent(n)})}else{console.log("no layer :(")}};var n={handle:e};return n}();var f=function(){var e=function(e){console.log("geo coding cusomt viewer entered")};var t={handle:e};return t}();var l={house:u,geocoding:f,airquality:s,restaurant:o,schools:a,police:i};var c={handle:e};return c}